<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>科迪会员录入系统</title>
    <link rel="icon" href="../images/kd.ico" type="image/x-icon" />
    <link rel="stylesheet" href="../css/H-ui.min.css">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/iconfont.css">
    <link rel="stylesheet" href="../css/kd.css">
    <link rel="stylesheet" href="../css/layer.css">
    <script src="../script/vue.min.js"></script>
    <script src="../script/jquery-2.1.1.min.js"></script>
    <script src="../script/H-ui.min.js"></script>
    <script src="../script/common.js"></script>
    <script src="../script/kedi.js"></script>
    <script src="../script/loading.js"></script>
    <script src="../DatePicker/WdatePicker.js"></script>
    <script src="../script/layer.js"></script>
    <script src="../script/jquery.pagination.js"></script>
    <style>
        [v-cloak] {
            display: none;
        }
    </style>
</head>

<body>
    <div id="main">
        <div>
            <div>
                <button class="btn">{{lang_text.HistoryBorrow}}</button>
                <button class="btn">{{lang_text.OpenNewShop}}</button>
                <input disabled :value="history_no" type="text">
                <button class="btn">{{lang_text.AddNew}}</button>
            </div>
            <div>
                <span>{{lang_text.reporter}}</span><input disabled value="管理员" type="text">
                <span>DATE</span><input id="borrow_date" onclick="WdatePicker({el:this,dateFmt:'yyyy-MM-dd'})" class="Wdate date_to">
                <span>SC/Distributor</span><input v-model="searchByNo_no" type="text">
                <button @click="searchByNo($event)" class="btn">SerachHistory</button>
                <span>Products:</span><input id="producy_name_num" :type="producy_name_num.list[producy_name_num.default]">
                <button @click="reset($event)" class="btn">Reset</button>

            </div>
            
            <div style="padding:10px;">
                    <table class="table table-border table-bordered table-bg" style="width: 800px;background-color: rgba(200,200,200,.15);">
                        <thead>
                            <tr>
                                <th style="width: 70px;">编号</th>
                                <th style="width: 80px;">Name</th>
                                <th style="width: 70px;">MemberPrice</th>
                                <th style="width: 60px;">BV</th>
                                <th style="width: 60px;">PV</th>
                                <th style="width: 70px;">HistoryQty</th>
                                <th style="width: 60px;">BorrowQty</th>
                                <th style="width: 50px;">NowQty</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr :class="" @click="" v-for="(item,index) in borrow_product_list" v-if='borrow_product_list.length'>
                                <td :connect_id="item.productid">
                                    {{item.productno}}
                                </td>
                                <td>{{item.CName}}</td>
                                <td>{{item.MemberPrice}}</td>
                                <td>{{item.BV}}</td>
                                <td>{{item.PV}}</td>
                                <td>{{item.HistoryQty}}</td>
                                <td>{{item.BorrowQty}}</td>
                                <td>{{item.NowQty}}</td>
        
                            </tr>
                            <tr v-if="!borrow_product_list.length">
                                <td colspan="8"></td>
                            </tr>
                        </tbody>
                    </table>
            </div>

            <div>
                <div class="left">
                    <div class="">
                        <div class="left">
                            <span>BorrowedNaira</span> <span style="display:inline-block;width:100px;">0.0</span>
                        </div>
                        <div class="left">
                            <span>BorrowedBV</span> <span style="display:inline-block;width:100px;">0.0</span>
                        </div>
                        <div class="left">
                            <span>BorrowedPV</span> <span style="display:inline-block;width:100px;">0.0</span>
                        </div>
                        <div class="clear"></div>
                    </div>
                    <div class="">
                        <div class="left">
                            <span>ToBorrowNaira</span> <span style="display:inline-block;width:100px;">0.0</span>
                        </div>
                        <div class="left">
                            <span>ToBorrowBV</span> <span style="display:inline-block;width:100px;">0.0</span>
                        </div>
                        <div class="left">
                            <span>ToBorrowPV</span> <span style="display:inline-block;width:100px;">0.0</span>
                        </div>
                        <div class="clear"></div>
                    </div>
                </div>
                <div class="left">
                    <button @click="open_sale_report()" class="btn btn-primary">CretaeReport</button>
                </div>
                <div class="clear"></div>
            </div>
        </div>
    </div>

    <div id="sale_report" style="display:none;">
        <div>
            <div>
                编号：<input type="text">
                日期：<input disabled id="" onclick="WdatePicker({el:this,dateFmt:'yyyy-MM-dd'})" class="Wdate date_from">
                专卖店(SC)：<input disabled type="text" style="width:30px;">
                Memo：<input type="text">
            </div>
            <div>
                <table class="table table-border table-bordered table-bg" style="width: 800px;background-color: rgba(200,200,200,.15);">
                    <thead>
                        <tr>
                            <th style="width: 70px;">Code</th>
                            <th style="width: 80px;">Products</th>
                            
                            <th style="width: 60px;">BV</th>
                            <th style="width: 60px;">PV</th>
                            <th style="width: 70px;">MemberPrice</th>
                            <th style="width: 60px;">BorrowQty</th>
                            <th style="width: 50px;">Total BV</th>
                            <th style="width: 50px;">Total PV</th>
                            <th style="width: 50px;">Total NR</th>
                            <th style="width: 50px;">Code1</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr @click="" v-for="(item,index) in pro_list" v-if=''>
                            <td>{{item.productno}}</td>
                            <td>{{item.CName}}</td>
                            <td>{{item.BV}}</td>
                            <td>{{item.PV}}</td>
                            <td>{{item.MemberPrice}}</td>
                            <td>{{item.BorrowQty}}</td>
                            <td>{{item.BorrowQty*item.BV}}</td>
                            <td>{{item.BorrowQty*item.PV}}</td>
                            <td>{{item.BorrowQty*item.MemberPrice}}</td>
                            <td>{{item.productno}}</td>

                        </tr>
                        <tr v-if="">
                            <td colspan="8"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div>

            </div>
        </div>



        <div>
            <div class="left">
                <fieldset id="" style="">
                    <legend style="width: auto;margin-bottom: 5px; border-bottom: none;">信息Info</legend>
                
                    <div>
                        <span style="display:inline-block;width: 40px">Aera：</span><input type="text" style="width: 70px" >
                        <span style="display:inline-block;width: 120px">System Total：</span><input type="text" style="width: 150px" >
                        <span style="display:inline-block;width: 100px">Total Gurantee：</span><input type="text" style="width: 120px" >
                    </div>
                    <div>
                        <span style="display:inline-block;width: 40px">Kits：</span><input type="text" style="width: 20px" ><input type="checkbox" name="" id=""> <span>French</span>
                        <span style="display:inline-block;width: 115px">Gurantee Money：</span><input type="text" style="width: 150px" >
                        <span style="display:inline-block;width: 100px">TotalNR：</span><input type="text" style="width: 120px" >
                    </div>
                </fieldset>
            </div>
            <div class="left">
                <fieldset id="" style="">
                    <legend style="width: auto;margin-bottom: 5px; border-bottom: none;">操作Operate</legend>
                    <div>
                        <button class="btn" style="width: 180px;">保存Save</button><br/>
                        <button class="btn" style="width: 180px;">GoToWareHouse</button><br/>
                        <button class="btn">RevertFromWareHouse</button>
                    </div>
                </fieldset>
            </div>
        </div>
    </div>    

    <script>

        var p_index = '';
        $(function () {
            get_borrow_product_list();          //获取商品列表
            $('.Wdate').val(get_local_time());


            $("#producy_name_num").keyup(function(e){
                
                if($(this).attr('type')=='text' && e.keyCode == 13){
                    console.log($(this).attr('type'));
                    // console.log(check_has_name($(this).val()));
                    bind_product_name();
                }else if($(this).attr('type')=='number' && e.keyCode == 13){
                    console.log($(this).attr('type'));
                    borrow_main.borrow_product_list[p_index].BorrowQty = $(this).val();
                    bind_product_qty();
                }
            })
            
        })
        var borrow_main = new Vue({
            el:'#main',
            data:{
                searchByNo_no:'', 
                history_no:'',
                borrow_product_list : [],
                producy_name_num : {default:0,list:['text','number']},
                product_borrow_history : [],
                product_history_borrow_qty:[],
                lang_text:splicing_obj(get_page_txt('borrow'))
            },
            methods:{
                // get_borrow_product_list(){

                // }
                searchByNo(){
                    searchByNo_exe(this.searchByNo_no)
                },
                open_sale_report(){
                    var naira;
                    // compute_bv()
                    var str = `
                        <div style="padding:0 20px;">
                            <div></div>
                            <div>SC:${this.history_no||''}  NAIRA:${compute_by('MemberPrice')}</div>
                            <div>BV: ${compute_by('BV')}   PV:${compute_by('PV')}</div>
                            <p>以上订单信息是否正确?</p>
                        </div>
                    `
                    firm('订单信息检查',str,{l:'是',r:'否'},check_pass_open)
                    
                },
                reset(){
                    reset_exe()
                }

            }
        })

        function check_pass_open() {
            sale_report.pro_list = borrow_main.borrow_product_list;
            var arr = [],o_arr = borrow_main.borrow_product_list;
            for(var i = 0; i < o_arr.length;i++){
                if(o_arr[i].BorrowQty!=''){
                    arr.push({'productno':o_arr[i].productno,'BorrowQty':o_arr[i].BorrowQty})
                }
            }
            
            var url = '/index.php?s=desktop/Borrow/button6_Click';
            var user_token = get_cache('usertoken');
            var data = {};
            data["usertoken"] = user_token;
            data["totalBv"] = compute_by('BV');
            data["totalpv"] = compute_by('PV');
            data["totalnaira"] = compute_by('MemberPrice');
            data["Date"] = $('#borrow_date').val();
            data["data"] = arr;
            data["GroupID"] = borrow_main.history_no;
            data["shopno"] = borrow_main.searchByNo_no;
            ajax(url,data,function (ret) {
                if(ret.stat){
                    console.log(ret);
                }
            })


            console.log(arr)
            open_html("SaleReport",'#sale_report','sale_report',function(){
//		                Refresh()
                
            },900,500)

        }

        function searchByNo_exe(para) {
            var url = '/index.php?s=desktop/Borrow/Form1_Load';
            var user_token = get_cache('usertoken');
            var data = {};
            data["usertoken"] = user_token;
            data["shopno"] = para;
            ajax(url,data,function (ret) {
                if(ret.stat){
                    
                }
            })
        }

        function bind_product_qty() {  
                $('#producy_name_num').val('');
                $('#producy_name_num').attr('type','text');
        }

        function bind_product_name() {

            if(check_has_name($('#producy_name_num').val().toUpperCase())>=0){

                p_index = check_has_name($('#producy_name_num').val().toUpperCase());
                console.log(check_has_name($('#producy_name_num').val().toUpperCase()));
                console.log( borrow_main.borrow_product_list);    
                $('#producy_name_num').val('');

                $('#producy_name_num').attr('type','number');
            }
            
            // if(arr.includes($('#producy_name_num').val().toUpperCase())){
            //     console.log('Tamia');
            //     $('#producy_name_num').val('');

            //     $('#producy_name_num').attr('type','number');

            // }

        }
        
        function check_has_name(a){
            var l = borrow_main.borrow_product_list,index = -1||'';
            for(var i = 0;i<l.length;i++){
                if(a.toUpperCase() == l[i].productno){
                    index = i;
                }
                // console.log(l[i].productno);
            }
            return index;
        }

        function get_borrow_product_list() {
            var url = '/index.php?s=desktop/Borrow/Form1_Load';
            var user_token = get_cache('usertoken');
            var data = {};
            data["usertoken"] = user_token;
            ajax(url,data,function (ret) {
                if(ret.stat){
                    borrow_main.borrow_product_list = ret.data.Product_Info;
                    borrow_main.history_no = ret.data.groupid;
                    borrow_main.searchByNo_no = ret.data.shopno;
                    borrow_main.product_borrow_history = ret.data.BorrowQty||[];

                    borrow_main.product_history_borrow_qty = ret.data.HistoryBorrow||[];
                    
                    for(var j = 0 ;j<borrow_main.product_borrow_history.length;j++){
                        for(var k = 0; k<borrow_main.borrow_product_list.length;k++){
                            if(borrow_main.borrow_product_list[k].productno == borrow_main.product_borrow_history[j].productno){
                                console.log(borrow_main.borrow_product_list[k].productno);
                                borrow_main.borrow_product_list[k].BorrowQty = borrow_main.product_borrow_history[j].QTY;
                            }
                        }
                    }
                    for(var j = 0 ;j<borrow_main.product_history_borrow_qty.length;j++){
                        for(var k = 0; k<borrow_main.borrow_product_list.length;k++){
                            if(borrow_main.borrow_product_list[k].productno == borrow_main.product_history_borrow_qty[j].productno){
                                // console.log(borrow_main.borrow_product_list[k].productno);
                                borrow_main.borrow_product_list[k].HistoryQty = borrow_main.product_history_borrow_qty[j].QTY;
                            }
                        }
                    }
                }

            })
        }

        function reset_exe() {
            var l = borrow_main.borrow_product_list;
            for(var i = 0;i<l.length;i++){
                l[i].BorrowQty = '-';
            }
        }

        //计算
        function compute_by(item) {
            var para = 0,arr = borrow_main.borrow_product_list;
            for(var i = 0;i<arr.length;i++){
                // console.log(i)
                if(!isNaN(arr[i].BorrowQty)){
                    // console.log(arr[i].BorrowQty*arr[i].BV)
                    para += (arr[i].BorrowQty*arr[i][item]);
                }
                
            }
            return para;
        }

        var sale_report = new Vue({
            el:'#sale_report',
            data:{
                pro_list:[]

            }
        })
    </script>

</body>

</html>