<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>科迪会员录入系统</title>
    <link rel="icon" href="../images/kd.ico" type="image/x-icon" />
    <link rel="stylesheet" href="../css/bootstrap.min.css">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/iconfont.css">
    <link rel="stylesheet" href="../css/kd.css">
    <link rel="stylesheet" href="../css/layer.css">
    <script src="../script/vue.min.js"></script>
    <script src="../script/jquery-2.1.1.min.js"></script>
    <script src="../script/bootstrap.js"></script>
    <!-- <script src="../script/H-ui.min.js"></script> -->
    <script src="../script/common.js"></script>
    <script src="../script/kedi.js"></script>
    <script src="../script/loading.js"></script>
    <script src="../DatePicker/WdatePicker.js"></script>
    <script src="../script/layer.js"></script>
    <script src="../script/jquery.pagination.js"></script>
    <style>
        [v-cloak] {
            display: none;
        }

        @media (min-width: 768px){
            .huankuan_modal {
               width: 80%!important;
            }
        }
    </style>
</head>

<body>
    <body>
        <div class="container" id="app">
            <h1 class="text-center">贷款列表</h1>
            <h5 class="page-header"></h5>
            <form class="form-inline">
                <div class="form-group">
                    <label>类型：</label>
                    <select class="form-control" v-model="where.dtype">
                        <option v-for="item in typelist" :value="item.id">{{item.type_name}}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="control-label">贷款编号:</label>
                    <input class="form-control" v-model="where.id"/>
                </div>
                <div class="form-group">
                    <label class="control-label">专卖店号/经销商号：</label>
                    <input class="form-control" v-model="where.sc">
                </div>
                <div class="form-group">
                    <label class="control-label">借款时间范围：</label>
                    <input id="r_start" onclick="WdatePicker({el:this,dateFmt:'yyyy-MM-dd'})" class="form-control Wdate date_to" type="" name="" v-model="where.start_time"> - <input id="r_end" class="form-control Wdate date_to" onclick="WdatePicker({el:this,dateFmt:'yyyy-MM-dd'})" type="" name="" v-model="where.end_time">
                </div>
                <div class="form-group">
                    <label class="control-label">是否还清：</label>
                    <select class="form-control" v-model="where.is_over">
                        <option value="0">全部</option>
                        <option value="2">是</option>
                        <option value="1">否</option>
                    </select>
                </div>
                <a class="btn btn-primary" @click="getdata()"> SEARCH</a>
            </form>
            <h5 class="page-header"></h5>
            <table id="daikuan_table" class="table table-striped table-hover">
                <thead>
                    <tr><th style="width:auto;">贷款编号</th>
                        <th>sc</th>
                        <th>贷款日期</th>
                        <th>贷款类型</th>
                        <th>贷款总额</th>
                        <th>剩余还款</th>
                        <th>是否还清</th>
                        <th>备注</th>
                        <th>操作员</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="item in datalist" @click="showdetail(item)">
                        <td>{{item.id}}</td>
                        <td>{{item.sc}}</td>
                        <td>{{item.date}}</td>
                        <td>{{typelist[Number(item.type_id)].type_name}}</td>
                        <td>{{item.total_money}}</td>
                        <td>{{item.surplus_money}}</td>
                        <td>{{item.is_over == 1?'否':'是'}}</td>
                        <td>{{item.memo}}</td>
                        <td>{{item.oper}}</td>
                        <td><a class="btn btn-primary btn-xs" @click.stop=xiugai() style="margin-right:5px;">修改</a><a class="btn btn-primary btn-xs" @click.stop=openlist(item)>还款列表</a></td>
                    </tr>
                </tbody>
            </table>
            <nav class="pull-right" style="background:none;">
              <ul class="pagination">
                <li>
                  <a href="#" aria-label="Previous">
                    <span aria-hidden="true">&laquo;</span>
                  </a>
                </li>
                <li><a href="#">1</a></li>
                <li><a href="#">2</a></li>
                <li><a href="#">3</a></li>
                <li><a href="#">4</a></li>
                <li><a href="#">5</a></li>
                <li>
                  <a href="#" aria-label="Next">
                    <span aria-hidden="true">&raquo;</span>
                  </a>
                </li>
              </ul>
            </nav>
            <div class="modal fade" tabindex="-1" id="momo_win">
                <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title">备注信息</h4>
                    </div>
                    <div class="modal-body">
                        <form class="form-horizontal">
                            <div class="form-group">
                                <label class="col-sm-3 control-label">贷款编号：</label>
                                <div class="col-sm-7">
                                    <input class="form-control" :value="detail.id" readonly />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">sc：</label>
                                <div class="col-sm-7">
                                    <input class="form-control" :value="detail.sc" readonly />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">贷款日期：</label>
                                <div class="col-sm-7">
                                    <input class="form-control" :value="detail.date"  readonly />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">贷款类型：</label>
                                <div class="col-sm-7">
                                    <input class="form-control" :value="detail.type_id==1?'个人':detail.type_id==2?'房屋':'业绩'" readonly />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">贷款总额：</label>
                                <div class="col-sm-7">
                                    <input class="form-control" :value="detail.total_money" readonly />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">剩余总额：</label>
                                <div class="col-sm-7">
                                    <input class="form-control" :value="detail.surplus_money" readonly />
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">备注：</label>
                                <div class="col-sm-7">
                                    <textarea class="col-sm-7 form-control" rows=5 readonly>{{detail.memo}}</textarea>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-3 control-label">操作员：</label>
                                <div class="col-sm-7">
                                    <input class="form-control" :value="detail.oper" readonly />
                                </div>
                            </div>
                        </form>
        
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->
            </div><!-- /.modal -->
    
                <!-- 还款列表 -->
            <div class="modal fade" style="min-height:200px;" id="repay_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
                <div class="modal-dialog huankuan_modal" role="document">
                    <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">还款列表</h4>
                    </div>
                    <div class="modal-body">
                        <form class="form-inline">
                                <div class="form-group">
                                    <label>类型：</label>
                                    <select class="form-control" v-model="re_where.dtype">
                                        <option v-for="item in refund_typelist" :value="item.id">{{item.type_name}}</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="control-label">贷款编号:</label>
                                    <input class="form-control" v-model="re_where.id"/>
                                </div>
                                <div class="form-group">
                                    <label class="control-label">专卖店号/经销商号：</label>
                                    <input class="form-control" v-model="re_where.sc">
                                </div>
                                <div class="form-group">
                                    <label class="control-label">还款时间范围：</label>
                                    <input id="huankuan_start" onclick="WdatePicker({el:this,dateFmt:'yyyy-MM-dd'})" class="form-control Wdate date_to" type="" name=""> - <input id="huankuan_end" class="form-control Wdate date_to" onclick="WdatePicker({el:this,dateFmt:'yyyy-MM-dd'})" type="" name="">
                                </div>
                                <span class="btn btn-primary" @click.stop="get_redata()">SEARCH</span>
                        </form>
                        <div style="overflow-x:scroll;">
                        <table style="width:120%;" class="table table-striped table-hover">
                            <thead>
                                <tr><th style="width:auto;">贷款编号</th>
                                    <th>sc</th>
                                    <th>贷款日期</th>
                                    <th>贷款类型</th>
                                    <th>贷款总额</th>
                                    <th>剩余还款总额</th>
                                    <th>是否已还清</th>
                                    <th>还款日期</th>
                                    <th>还款金额</th>
                                    <th>还款类型</th>
                                    <th>备注</th>
                                    <th>操作员</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="item in refund_list">
                                    <td>{{item.borrow_ret.id}}</td>
                                    <td>{{item.borrow_ret.sc}}</td>
                                    <td>{{item.borrow_ret.date}}</td>
                                    <td>{{item.borrow_ret.type_id}}</td>
                                    <td>{{item.borrow_ret.total_money}}</td>
                                    <td>{{item.borrow_ret.surplus_money}}</td>
                                    <td>{{item.borrow_ret.is_over == 1?'否':'是'}}</td>
                                    <td>{{item.log_time}}</td>
                                    <td>{{item.amount}}</td>
                                    <td>{{compute_refund_type(item.type_id)}}</td>
                                    <!-- <td>{{item.type_id == 4?'teller':item.type_id == 5?'cash':''}}</td> -->
                                    <td>{{item.memo}}</td>
                                    <td>{{item.oper}}</td>
                                    <td><a class="btn btn-primary btn-xs" @click.stop=refund_delete(item.id,item.borrow_ret.id,item.amount)>删除</a></td>
                                </tr>
                            </tbody>
                        </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">确定</button>
                        <!-- <button type="button" class="btn btn-primary">Save changes</button> -->
                    </div>
                    </div>
                </div>
            </div>
                      

            </div>	


            
    </body>
    


    <script type="text/javascript">
        var formtype = 'borrow'; //borrow 借款， payback_active主动还款 ，payback_passive被动还款
    
        var vm = new Vue({
            el:'#app',
            data:{
                typelist : [ {id: "0", type_name: "全部", key: "1"}],
                refund_typelist : [ {id: "0", type_name: "全部", key: "1"}],
                datalist : [],
                re_where:{
                    dtype : 0,
                    id:'',
                    sc:'',

                },
                where : {
                    is_over:0,
                    start_time : '',
                    end_time : '',
                    id : '',
                    dtype : 0,
                    sc : ''
                },
                detail:{},
                pagination:{
                    maxpage : 10,
                    currentpage:1
                },
                refund_list:[]
            },
            methods : {
                init : function(){
                    this.gettypelist();
                    this.getdata();
                    this.getrefund_typelist();
                    // this.date_init();
                },
                date_init : function(){
                    console.log(45613656)
                    // $('.Wdate').val(get_local_time());
                },
                compute_type : function(i){
                    return this.typelist[i].type_name;
                },

                compute_refund_type : function(para){
                    console.log(para);
                    for(var i = 0; i<this.refund_typelist.length; i++){
                        if(para == this.refund_typelist[i].id){
                            return this.refund_typelist[i].type_name;
                        }
                    }
                },
                gettypelist : function(){
                    // this.typelist = [
                    //     {id:0,title:'==全部=='},
                    //     {id:1,title:'个人'},
                    //     {id:2,title:'房'},
                    //     {id:3,title:'车'}
                    // ];

                    var url = '/index.php?s=desktop/Refund_Borrow_Type/listAc';
                    var user_token = get_cache('usertoken');
                    var data = {};
                    data["usertoken"] = user_token;
                    // data[""] = ;
                    console.log(data)
                    ajax(url,data,function (ret) {
                        if(ret.stat){
                            var l = ret.data;
                            for(var i = 0; i < l.length;i++){
                                vm.typelist.push(l[i]);
                            }
                        }
                    })
                },
                getrefund_typelist(){
                    var url = '/index.php?s=desktop/Refund_Borrow_Type/refund_list';
                    var user_token = get_cache('usertoken');
                    var data = {};
                    data["usertoken"] = user_token;
                    // data[""] = ;
                    console.log(data)
                    ajax(url,data,function (ret) {
                        if(ret.stat){
                            var l = ret.data;
                            for(var i = 0; i < l.length;i++){
                                vm.refund_typelist.push(l[i]);
                            }
                        }
                    })
                },
                getdata:function(){

                    var url = '/index.php?s=desktop/Refund_Borrow/listAc';
                    var user_token = get_cache('usertoken');
                    var data = {};
                    data["usertoken"] = user_token;
                    data["sc"] = this.where.sc;
                    data["is_over"] = this.where.is_over;
                    data["typeid"] = this.where.dtype;
                    data["id"] = this.where.id;
                    // data["from"] = this.where.start_time;
                    data["from"] = $("#r_start").val();
                    data["to"] = $("#r_end").val();
                    // data["to"] = this.where.end_time;
                    data["offset"] = '';
                    data["limit"] = '';    
                    console.log(data)
                    ajax(url,data,function (ret) {
                        if(ret.stat){
                            vm.datalist = ret.data.list;
                        }
                    })
                    //根据where条件查找数据
                    // alert(JSON.stringify(this.where));
                    // this.datalist = [
                    //     {id:1,sc:'001','memo':'很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本'},
                    //     {id:2,sc:'001','memo':'很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本'},
                    //     {id:3,sc:'001','memo':'很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本'},
                    //     {id:4,sc:'001','memo':'很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本'},
                    //     {id:5,sc:'001','memo':'很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本'},
                    //     {id:6,sc:'001','memo':'很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本'},
                    //     {id:7,sc:'001','memo':'很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本'},
                    //     {id:8,sc:'001','memo':'很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本'},
                    //     {id:9,sc:'001','memo':'很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本'},
                    //     {id:11,sc:'001','memo':'很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本'},
                    //     {id:12,sc:'001','memo':'很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本很长的文本'},
                    // ];
                },
                get_redata : function(){
                    console.log('返回还款');
                    var url = '/index.php?s=desktop/Refund_Borrow_Log/get_refund_list';
                    var user_token = get_cache('usertoken');
                    var data = {};
                    data["usertoken"] = user_token;
                    data["sc"] = this.re_where.sc;
                    data["typeid"] = this.re_where.dtype;
                    data["id"] = this.re_where.id;
                    // data["from"] = this.where.start_time;
                    data["from"] = $("#huankuan_start").val();
                    data["to"] = $("#huankuan_end").val();
                    // data["to"] = this.where.end_time;
                    data["offset"] = '';
                    data["limit"] = '';    
                    console.log(data)
                    ajax(url,data,function (ret) {
                        if(ret.stat){
                            var borrow_ret = ret.data.borrow_info,borrow_ex={},
                                refund_ret = ret.data.refund_info;
                            for (const i in borrow_ret) {
                                // borrow_ex[borrow_ret[i].id] = borrow_ret[i];
                                for(const j in  refund_ret){
                                    
                                    if(refund_ret[j].refundborrow_id == borrow_ret[i].id){
                                        refund_ret[j].borrow_ret = borrow_ret[i];
                                        
                                    }
                                    
                                }
                            }
                            vm.refund_list = refund_ret;
                            console.log( vm.refund_list)

                        }else if(ret.stat == 0){
                            showErr_bs(ret.errmsg);
                        }
                    })
                },
                showdetail : function(detail){
                    this.detail = detail;
                    // console.log(this.typelist,detail);
                    var selectionObj = window.getSelection();
            　　　　 var rangeObj = selectionObj.getRangeAt(0);
            　　　 　var docFragment = rangeObj.cloneContents();
                    console.log(selectionObj.toString());
                    if(selectionObj.toString() == ''){
                        $("#momo_win").modal();
                    }
                    // $("#momo_win").modal();
                },
                openlist : function(item){
                    
                    // vm.re_where.id = item.id;
                    vm.re_where.sc = item.sc;
                    $('#repay_modal').modal()
                    this.get_redata()
                    // alert(id + '打开相应的还款列表')
                },
                xiugai : function(){

                },
                refund_delete: function(repay_id,borrow_id,amount){
                    console.log(repay_id,borrow_id,amount);
                    var url = '/index.php?s=desktop/Refund_Borrow_Log/del_refund';
                    var user_token = get_cache('usertoken');
                    var data = {};
                    data["usertoken"] = user_token;
                    data["id"] = repay_id;
                    data["refundborrow_id"] = borrow_id;
                    data["amount"] = amount;
                    ajax(url,data,function (ret) {
                        if(ret.stat){
                            vm.get_redata()
                        }
                    })
                }
            }
        });
        vm.init();
    
    </script>
</body>

</html>